Yandex DataBase (YDB) — это облачная база данных со следующими требованиями:
1) SQL-подобный язык запросов.
2) Строгая поддержка транзакций с сильной консистентностью.
3) Самовосстановление после сбоев стоек, серверов, дисков — без вмешательства инженеров.
4) Автоматическое горизонтальное масштабирование по ресурсам хранения и вычислений.
5) Основной фокус — надёжное хранение данных с высокой скоростью доступа.

Для обеспечения таких требований был разработан собственный слой хранения данных, отказавшийся от стандартных файловых систем.


Причины отказа от файловой системы:

| Плюсы файловых систем                           | Минусы файловых систем                                                   |
| ----------------------------------------------- | ------------------------------------------------------------------------ |
| Удобная организация структуры хранения          | Невозможность вносить специализированные изменения                       |
| Простота обучения и эксплуатации                | Избыточные записи метаданных (создание/удаление файлов = запись на диск) |
| Возможность резервного копирования              | Лишний слой абстракции увеличивает накладные расходы                     |
| Доступ к готовому коду ядра ОС                  | Потери производительности до 16%                                         |
| Поддержка деления устройства между приложениями | Фрагментация и непредсказуемость поведения при высоких нагрузках         |

Вывод:  
Стандартные файловые системы не подходят для работы с огромными объёмами данных и требованиями к минимальной задержке в YDB.

Архитектура хранения:
![YDB](https://github.com/user-attachments/assets/a026a51b-e908-462d-8030-12fe519855a8)

1) Работа напрямую с блочными устройствами через свой userspace-драйвер.
2) Собственная реализация всех файловых операций без ядра Linux.
3) Никаких стандартных буферов ОС (открытие файлов с `O_DIRECT`, синхронная запись).
4) Контроль всех операций чтения/записи через планировщик в приложении.

Структура данных на диске:
1) Superblock — записывается один раз при форматировании (размер диска, сектора).
2) Syslog — редкие записи о состоянии файловой системы.
3) Append-only Log: данные пишутся последовательно в чанки по 128 MB, один чанк заканчивается — пишется ссылка на следующий, обрезка логов делается изменением указателя.

Специфика записи и работы
- Все операции записи идут через асинхронные очереди (`libaio` или в будущем `io_uring`). 
- Пользовательский запрос считается завершённым только после **реальной записи на диск**.
- Реализация собственного планировщика дисковых операций: приоритет реального времени для критичных транзакций, фоновые задачи (компактация данных, аналитика) обрабатываются с низким приоритетом.

Оптимизация для скорости

| Техника                                   | Описание                                                                    |
| ----------------------------------------- | --------------------------------------------------------------------------- |
| Отключение RAID-кэша устройств            | Контроль записи только приложением для надёжности и скорости                |
| Склеивание логов                          | Множественные записи разных клиентов объединяются в один большой лог-запись |
| Аппендовая модель записи                  | Письмо всегда в конец, что минимизирует нагрузку на диски                   |
| Распараллеливание через виртуальные диски | Эмуляция нескольких виртуальных дисков на одном физическом устройстве       |

Хранение данных
- Типичная единица хранения — blob от 1 MB до 10 MB.
- Система поддерживает миллионы и миллиарды объектов.
- Все записи реплицируются для надёжности: мультидатацентровая репликация: 3 реплики в разных дата-центрах, кодирование с избыточностью: 4 части данных + 2 контрольных (Reed-Solomon кодирование).
   
Проблемы и решения:

| Проблема                                 | Решение                                                                         |
| ---------------------------------------- | ------------------------------------------------------------------------------- |
| HDD стареют через 3 года                 | Постоянная проверка целостности данных (background scrubbing)                   |
| Потери данных при отключении питания     | Тестирование на потерю в "полёте" с агрессивным аварийным завершением процессов |
| Потери данных из-за деградации чтения    | Восстановление данных из оставшихся реплик                                      |
| Ошибки при замене дисков инженерами      | Полный учёт серийников и контроль правильности замены                           |
| Репликация на HDD слишком долгая (сутки) | Переход на NVMe-устройства, где полная репликация занимает ≈10 минут            |

Архитектура решения


| **Плюсы**                                                           | **Минусы**                                                                             |
| ------------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| Минимальная нагрузка на ядро ОС                                     | Требуется сложная реализация и поддержка пользовательского драйвера                    |
| Высокая скорость записи и чтения                                    | Повышенные требования к инженерной дисциплине (контроль серийников, менеджмент дисков) |
| Надёжность хранения за счёт мульти-репликации и скраббинга          | Стоимость разработки и поддержки собственного слоя хранения                            |
| Возможность работы с тысячами дисков и гибкая балансировка нагрузки | Необходимость тестирования сложных отказоустойчивых сценариев                          |
| Независимость от файловых систем и возможностей ядра                | Специфический код — сложная интеграция с внешними решениями                            |

Дополнительные детали:
Использование виртуальных дисков позволяет эффективно балансировать нагрузку даже при высокой частоте операций.
Операции репликации оптимизированы для ускорения при помощи склеивания маленьких операций в одну большую.
В случае выхода сервера из строя данные можно **физически** перенести дисками без потери.
Планируется полная автоматизация присоединения новых дисков без участия инженеров.
База активно развивается в сторону поддержки низколатентных real-time систем через улучшения планировщика.
